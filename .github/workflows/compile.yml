# 工作流名称
name: 编译报告并发布到 Release (Compile and Release PDFs)

# 触发条件：推送到 master 分支时
on:
  push:
    branches:
      - master

# 工作流任务
jobs:
  build_and_release:
    # 运行环境
    runs-on: ubuntu-latest
    
    # 授予工作流写入仓库内容的权限，这是创建 Release 所必需的
    permissions:
      contents: write

    steps:
      # 第 1 步：检出仓库代码
      - name: 检出仓库代码 (Checkout repository)
        uses: actions/checkout@v4

      # 第 2 步：安装 TeX Live 环境并直接在其中运行编译脚本
      # 这是关键的修改：将编译命令合并到此步骤中
      - name: 安装并使用 TeX Live 编译 (Setup TeX Live & Compile)
        uses: xu-cheng/texlive-action@v2
        with:
          # scheme: full 确保所有宏包（尤其是中文支持）都可用
          scheme: full
          # 使用 run 参数，让下面的脚本在已安装 TeX Live 的环境中执行
          run: |
            echo "开始在 TeX Live 环境中编译..."
            mkdir -p compiled_reports
            for file in $(find . -type f -name "*.tex" ! -path "./template/*" ! -name "template.tex"); do
              echo "正在编译: $file"
              # 使用 latexmk 进行高效编译
              latexmk -xelatex -output-directory=compiled_reports -cd "$file"
            done
            echo "所有文件编译完成。"

      # 第 3 步：创建或更新 Release 并上传 PDF
      # 这一步不需要改变，它会在上一步成功后执行
      - name: 创建/更新 Release 并上传PDF (Create/Update Release and Upload PDFs)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest-reports
          name: 最新实验报告 (Latest Reports)
          body: |
            自动编译生成的最新实验报告PDF。
            此 Release 由 GitHub Action 自动更新。
          prerelease: true
          files: compiled_reports/*.pdf

